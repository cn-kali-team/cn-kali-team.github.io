<!doctype html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8">
    <meta name="baidu-site-verification" content="dIcXMeY8Ya">
    
    <title>Nmap 扫描(防火墙 Bypass) | Kali-Team</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="keywords" content="Kali-Team, 三米前有蕉皮">
    <meta name="description" content="Kali-Team">

    
    <link rel="alternative" href="/atom.xml" title="Kali-Team" type="application/atom+xml">
    
    
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    

</head>
</html>
<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Kali-Team</span>
                    <span class="description">三米前有蕉皮</span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/2018/04/09/Nmap-扫描-防火墙-Bypass/index.html" class="item ">
                <a href="/" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="/2018/04/09/Nmap-扫描-防火墙-Bypass/index.html" class="item ">
                <a href="/lab/" title="实验室" class="icon-lab">&nbsp;实验室</a>
            </li>
            
            <li rel="/2018/04/09/Nmap-扫描-防火墙-Bypass/index.html" class="item ">
                <a href="/about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="/2018/04/09/Nmap-扫描-防火墙-Bypass/index.html" class="item ">
                <a href="/comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/cn-kali-team" target="_blank">Github</a>
                        |
                    
                </p>
                <p class="sns">
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/favicon.ico" alt="avatar" title="Kali-Team">
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章页 -->
<!-- 文章 -->
<article class="post article">
    <header class="text-center">
        <h3 class="post-title"><span>Nmap 扫描(防火墙 Bypass)</span></h3>
    </header>
    <p class="post-meta text-center">
        Kali-Team 发表于
        <time datetime="2018-04-09T14:24:03.000Z">2018-04-09</time>
    </p>
    <div class="post-content">
        <h1 id="Nmap-Ping-扫描-防火墙-Bypass"><a href="#Nmap-Ping-扫描-防火墙-Bypass" class="headerlink" title="Nmap Ping 扫描(防火墙 Bypass)"></a>Nmap Ping 扫描(防火墙 Bypass)</h1><hr>
<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><ul>
<li>在本文中，我们将使用不同的Nmap Ping扫描来扫描发现目标主机。</li>
<li>一个系统管理员可能只会使用Ping来检测某个主机是否存活，但一个安全人员可能会使用各种方法绕过防火墙进行检测。</li>
<li><p>在Namp中使用Ping扫描来检测主机是否存活。我们知道在默认情况下，Ping发送ICMP回应请求，并在系统处于活动状态时获取ICMP响应回复。默认情况下，Ping扫描发送一个ARP数据包来获取主机是否存活。</p>
</li>
<li><p>Nmap会根据它扫描的网络来改变它的扫描方式。<br><em>1.</em>如果扫描的是本地网络，Nmap在每次扫描时发送ARP数据包<br><em>2.</em>如果时扫描外网就发送以下请求数据包：</p>
<blockquote>
<ol>
<li>ICMP回应请求</li>
<li>ICMP时间戳请求</li>
<li>TCP SYN到端口443</li>
<li>TCP ACK到端口80</li>
</ol>
</blockquote>
</li>
<li><p>在本文，我们使用-disable-arp-ping属性来更改Nmap的扫描行为，将本地网络当作外网。</p>
</li>
</ul>
<a id="more"></a>
<h3 id="0x01-开始"><a href="#0x01-开始" class="headerlink" title="0x01 开始"></a>0x01 开始</h3><ul>
<li>为了在不使用ARP请求数据包的情况下识别存活主机，Nmap使用称扫描的-sP选项。我们可以使用-sn标志，这意味没有端口扫描也称为Ping扫描。</li>
<li>我的IP：172.17.0.1【Ubuntu】</li>
<li>目标IP：172.17.0.2 【Ubuntu】- docker<blockquote>
<p>sudo nmap -sP 172.17.0.2 -disable-arp-ping</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap <span class="number">7.01</span> ( <span class="string">https:</span><span class="comment">//nmap.org ) at 2018-03-06 16:58 CST</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">Host is up (<span class="number">0.00013</span>s latency).</span><br><span class="line">MAC <span class="string">Address:</span> <span class="number">02</span>:<span class="number">42</span>:<span class="string">AC:</span><span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> (Unknown)</span><br><span class="line">Nmap <span class="string">done:</span> <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned <span class="keyword">in</span> <span class="number">0.31</span> seconds</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p>或者</p>
<blockquote>
<p>sudo nmap -sn 172.17.0.2 -disable-arp-ping<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap <span class="number">7.01</span> ( <span class="string">https:</span><span class="comment">//nmap.org ) at 2018-03-06 16:59 CST</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">Host is up (<span class="number">0.000096</span>s latency).</span><br><span class="line">MAC <span class="string">Address:</span> <span class="number">02</span>:<span class="number">42</span>:<span class="string">AC:</span><span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> (Unknown)</span><br><span class="line">Nmap <span class="string">done:</span> <span class="number">1</span> IP address (<span class="number">1</span> host up) scanned <span class="keyword">in</span> <span class="number">0.29</span> seconds</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ul>
<li><p>从上面可以看到它发现有一台主机存活。再看下面的图片，由于我使用了参数–disable-arp-ping禁用了本地网络扫描的ARP请求数据包，所以这里并没有看到ARP请求。</p>
</li>
<li><p>通过wireshark可以看到这连个网络之间的请求和响应</p>
</li>
</ul>
<ol>
<li>ICMP回应请求</li>
<li>ICMP回应回复</li>
<li>TCP SYN到端口443</li>
<li>TCP RST，ACK到端口443</li>
<li>TCP ACK到端口80</li>
<li>TCP RST到端口80</li>
<li>ICMP时间戳请求</li>
<li>ICMP时间戳答复<h3 id="防Ping扫描"><a href="#防Ping扫描" class="headerlink" title="防Ping扫描"></a>防Ping扫描</h3></li>
</ol>
<ul>
<li>现在我在docker中用IPTABLES设置防火墙规则来拦截刚刚看到的ICMP数据包和443端口上的TCP SYN数据包还有80端口上的TCP ACK数据包，就应该可以防Ping扫描来了。<h3 id="出了点状况"><a href="#出了点状况" class="headerlink" title="出了点状况"></a>出了点状况</h3><blockquote>
<p>docker的iptables出了问题</p>
</blockquote>
</li>
<li>现在我的IP改为：192.168.43.236</li>
<li><p>目标IP改为：192.168.43.119 (虚拟机)</p>
</li>
<li><p>好，我们接着上面在目标主机设置防火墙：</p>
<blockquote>
<p>sudo iptables -I INPUT -p ICMP -j DROP<br>sudo iptables -I INPUT -p tcp –tcp-flags ALL ACK –dport 80 -j DROP<br>sudo iptables -I INPUT -p tcp –tcp-flags ALL SYN –dport 443 -j DROP</p>
</blockquote>
</li>
<li><p>现在我们在来扫一下，看到并没有检测到有存活主机，这说明我们配置的防火墙成功拦截了Nmap的Ping扫描。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sn 192.168.43.119 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-06 23:46 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 3.08 seconds</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用TCP-SYN-Ping绕过防火墙"><a href="#使用TCP-SYN-Ping绕过防火墙" class="headerlink" title="使用TCP SYN Ping绕过防火墙"></a>使用TCP SYN Ping绕过防火墙</h3><ul>
<li><p>下面的就可以发现存活主机了哦。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PS 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 20:11 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> ubuntu (192.168.43.132)</span><br><span class="line">Host is up (0.00062s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.31 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在我使用TCP SYN数据包Ping扫描绕过防火墙的规则，因为我们使用了-PS参数，-PS默认在80端口发送TCP SYN数据包；我们还可以指定端口，比如-PS443(指定443)端口。看下面的图就比较清楚了。</p>
</li>
</ul>
<h3 id="过滤TCP-SYN-Ping扫描"><a href="#过滤TCP-SYN-Ping扫描" class="headerlink" title="过滤TCP SYN Ping扫描"></a>过滤TCP SYN Ping扫描</h3><ul>
<li><p>升级一下，绕过管理员把TCP SYN数据包里的SYN数据包都过滤了怎么办？</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN -j DROP</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在Nmap有扫描不到主机是否存活了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PS 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:01 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 2.09 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用TCP-ACK-Ping绕过TCP-SYN-Ping"><a href="#使用TCP-ACK-Ping绕过TCP-SYN-Ping" class="headerlink" title="使用TCP ACK Ping绕过TCP SYN Ping"></a>使用TCP ACK Ping绕过TCP SYN Ping</h3><ul>
<li><p>为了绕过它，我们使用TCP ACK数据包的Ping扫描，所有要使用-PA参数来在80端口发送TCP ACK数据包，和上面一样也可以指定端口。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PA 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:06 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up (0.00082s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.36 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在有发现可以检测到主机在线了。在上面的图片中你可以看到ACK数据包发送到80端口。目标以RST数据包回复。</p>
<h3 id="再拦截上面的TCP-ACK-Ping扫描"><a href="#再拦截上面的TCP-ACK-Ping扫描" class="headerlink" title="再拦截上面的TCP ACK Ping扫描"></a>再拦截上面的TCP ACK Ping扫描</h3></li>
<li>这次把防火墙设置成TCP连接中的ACK数据包都拦截掉。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK -j DROP</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PA 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:18 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 2.10 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
<ul>
<li><p>然后上次的方法又不行了是吧，然而目标主机并不鸟我，请忽视第三个ssh协议的，那是我ssh登录上执行命令的。</p>
<h3 id="使用ICMP回环绕过TCP-ACK-Ping"><a href="#使用ICMP回环绕过TCP-ACK-Ping" class="headerlink" title="使用ICMP回环绕过TCP ACK Ping"></a>使用ICMP回环绕过TCP ACK Ping</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PE 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:25 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up (0.00081s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.49 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们要用Ping扫描ICMP数据包来绕过刚刚的规则，所以我们要使用-PE参数发送ICMP回环数据包。</p>
<h3 id="再拦截上面的ICMP回环"><a href="#再拦截上面的ICMP回环" class="headerlink" title="再拦截上面的ICMP回环"></a>再拦截上面的ICMP回环</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -A INPUT -p icmp -m icmp --icmp-type <span class="built_in">echo</span>-request -j DROP</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PE 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:42 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 2.09 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
<ul>
<li><p>目标也没有回应，拦截成功。</p>
<h3 id="使用ICMP时间戳Ping绕过ICMP回环"><a href="#使用ICMP时间戳Ping绕过ICMP回环" class="headerlink" title="使用ICMP时间戳Ping绕过ICMP回环"></a>使用ICMP时间戳Ping绕过ICMP回环</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PP 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:46 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up (0.00087s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.35 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们使用Ping扫描和ICMP数据包来绕，所以我们要使用-PP参数来发送ICMP时间戳数据包。</p>
</li>
</ul>
<h3 id="我再拦截所有ICMP扫描"><a href="#我再拦截所有ICMP扫描" class="headerlink" title="我再拦截所有ICMP扫描"></a>我再拦截所有ICMP扫描</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -p ICMP -j DROP</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PP 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 21:59 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 2.10 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
<ul>
<li>看，又发现不了主机了，拦截也起作用了。注意：这会把你的ssh断开，不让你连接。可以输入下面命令清空防火墙规则。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -F</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用UDP绕ICMP扫描"><a href="#使用UDP绕ICMP扫描" class="headerlink" title="使用UDP绕ICMP扫描"></a>使用UDP绕ICMP扫描</h3><ul>
<li><p>上面我们已经学了很多种检测主机是否存活的方法了，就上一个防火墙的配置已经把ICMP扫描拦截了，或者把TCP的数据包拦截了，这样我们就很难知道主机是否存活。到这里我们来学习另一种方式：UDP扫描，所以我们要用-PU参数。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PU 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 22:11 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up (0.00086s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.35 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>看到目标回复<code>Destination unreachable (Port unreachable)</code>没，这就表示主机还活着。</p>
<h3 id="再再把UDP拦截了"><a href="#再再把UDP拦截了" class="headerlink" title="再再把UDP拦截了"></a>再再把UDP拦截了</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -p ICMP -j DROP</span><br><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK --dport 80 -j DROP</span><br><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN --dport 443 -j DROP</span><br><span class="line">sudo iptables -I INPUT -p udp -j DROP</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置好上面的就反人类了。UDP扫描没发现主机存活。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PU 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 22:22 CST</span><br><span class="line">Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (0 hosts up) scanned <span class="keyword">in</span> 2.10 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="利用协议绕过UDP和Ping"><a href="#利用协议绕过UDP和Ping" class="headerlink" title="利用协议绕过UDP和Ping"></a>利用协议绕过UDP和Ping</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PO 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 22:25 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up (0.00078s latency).</span><br><span class="line">MAC Address: 08:00:27:7D:2A:31 (Oracle VirtualBox virtual NIC)</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.35 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
<ul>
<li>在ICMP TCP和UDP都被拦截时，我们可以用-PO参数发送有IP头中特定协议号的IP数据包，如果没有指定协议，则发送多个用于ICMP，IGMP和IP-in-IP协议。</li>
<li><p>在上面抓包可以看出来：</p>
<blockquote>
<ol>
<li>发送ICMP Echo到目标主机</li>
<li>向目标发送IGMP查询</li>
<li>发送IPv4到目标主机</li>
<li>收到ICMP <code>Destination unreachable (Port unreachable)</code></li>
</ol>
</blockquote>
<h3 id="最后一个禁止IP协议扫描"><a href="#最后一个禁止IP协议扫描" class="headerlink" title="最后一个禁止IP协议扫描"></a>最后一个禁止IP协议扫描</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -p ICMP -j DROP</span><br><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK --dport 80 -j DROP</span><br><span class="line">sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN --dport 443 -j DROP</span><br><span class="line">sudo iptables -I INPUT -p udp -j DROP</span><br><span class="line">sudo iptables -I INPUT -p IP -j DROP</span><br></pre></td></tr></table></figure>
</li>
<li><p>就是在上一个加上拦截IP协议的就可以了。基本可以拦截很多方式的扫描了。</p>
</li>
<li><p>这个更反人类是吧，那怎么绕呢？</p>
<h3 id="使用NO-Ping绕过IP协议"><a href="#使用NO-Ping绕过IP协议" class="headerlink" title="使用NO Ping绕过IP协议"></a>使用NO Ping绕过IP协议</h3></li>
<li><p>当Ping扫描被拦截就用-PN参数，不用Ping扫描啊，这种方法可以判断主机的状态时up还是down。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sP -PN 192.168.43.132 -<span class="built_in">disable</span>-arp-ping</span><br><span class="line">Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 22:41 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.43.132</span><br><span class="line">Host is up.</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.04 seconds</span><br><span class="line">kali-team@Kali-Team:~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>发现啥都没有，完了！！！</p>
</li>
<li>-PN参数是跳过主机发现，假定主机时在线的，再执行后面的扫描，比如端口扫描，版本探测等等。因为这些测试时在主机为up的前提下执行的。所以会无视防火墙继续执行后面的测试。但是这应该比较费时间，本来主机都不在线，你又去扫了一遍。如果你是想：有杀过不放过的话可以试试。<h3 id="0x03-后续"><a href="#0x03-后续" class="headerlink" title="0x03 后续"></a>0x03 后续</h3></li>
<li>写了足足两天，其中docker里的iptables报错问题没解决，后面搭建了一台32位的Ubuntu，凑合用了。</li>
<li>今天课程排满了，吃完饭19:00开始写–现在到了23:00，不写了，去洗澡！！</li>
</ul>

    </div>
    <p class="post-meta">
        <span class="post-cat">分类：
            
        </span>
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/nmap/" title="nmap">nmap</a>
    

        </span>
    </p>
</article>
<!-- 分享按钮 -->


<!-- 上一篇/下一篇 -->

<div class="article-nav clearfix">
    
    <span class="prev fl">
        上一篇<br>
        <a href="/2018/04/09/获取Windows系统密码hash的几种方法/">
            
                获取Windows系统密码hash的几种方法
            
        </a>
    </span>
    

    
    <span class="next fr">
        下一篇<br>
        <a href="javascript: void(0);">没有下一篇了</a>
    </span>
    
</div>

<!-- 文章评论 -->

  <script src="/js/comment.js"></script>
  <div id="comments" class="comment">
    <!--
    <div class="sign-bar">
      GitHub 已登录!
      <span class="sign-link">登出</span>
    </div>
    <section class="box">
      <div class="com-avatar"><img src="/img/favicon.ico" alt="avatar"></div>
      <div class="com-text">
        <div class="main">
          <textarea class="text-area-edited show" placeholder="欢迎评论！"></textarea>
          <div class="text-area-preview"></div>
        </div>
        <div class="switch">
          <div class="switch-item on">编辑</div>
          <div class="switch-item">预览</div>
        </div>
        <div class="button">提交</div>
      </div>
    </section>
    <section class="tips">注：评论支持 markdown 语法！</section>
    <section class="list-wrap">
      <ul class="list">
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/favicon.ico" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">张德龙</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like liked">已赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">333333</div>
          </div>
        </li>
        <li>
          <div class="user-avatar">
            <a href="/">
              <img src="/img/favicon.ico" alt="user-avatar">
            </a>
          </div>
          <div class="user-comment">
            <div class="user-comment-header">
              <span class="post-name">刘德华</span>
              <span class="post-time">2017年12月12日</span>
              <span class="like">点赞</span>
              <span class="like-num">2</span>
            </div>
            <div class="user-comment-body">vvvvv</div>
          </div>
        </li>
      </ul>
      <div class="page-nav">
        <a href="javascript: void(0);" class="item">1</a>
        <a href="javascript: void(0);" class="item">2</a>
        <a href="javascript: void(0);" class="item current">3</a>
      </div>
    </section>
    -->
  </div>
  <script>
  JELON.Comment({
    container: 'comments',
    label: 'Nmap-扫描-防火墙-Bypass' || '2018/04/09/Nmap-扫描-防火墙-Bypass/',
    owner: 'cn-kali-team',
    repo: 'cn-kali-team.github.io',
    clientId: '0683bca9d762208912a9',
    clientSecret: 'fd3e06918ff647fd4b347dfeba033b588a957fc5'
  });
  </script>


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/Arch/">Arch</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/工具/">工具</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/漏洞复现/">漏洞复现</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="/categories/CTF/">CTF</a>
        <span class="badge">(11)</span>
    </li>
    
    <li>
        <a href="/categories/Web/">Web</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/Arch/" title="Arch">Arch (1)</a>
  
    <a class="tag-item" href="/tags/Genymotion/" title="Genymotion">Genymotion (1)</a>
  
    <a class="tag-item" href="/tags/漏洞复现/" title="漏洞复现">漏洞复现 (1)</a>
  
    <a class="tag-item" href="/tags/CTF/" title="CTF">CTF (11)</a>
  
    <a class="tag-item" href="/tags/web/" title="web">web (1)</a>
  
    <a class="tag-item" href="/tags/XSS/" title="XSS">XSS (1)</a>
  
    <a class="tag-item" href="/tags/Linux/" title="Linux">Linux (1)</a>
  
    <a class="tag-item" href="/tags/nmap/" title="nmap">nmap (1)</a>
  
    <a class="tag-item" href="/tags/metasploit/" title="metasploit">metasploit (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://gh0st.cn/" target="_blank" title="陈的博客">VulKey</a>
        </li>
    
        <li>
            <a href="https://10miaomiao.cn/" target="_blank" title="10喵喵的世界">飞跃</a>
        </li>
    
        <li>
            <a href="http://www.zmnihao.cn/" target="_blank" title="梓铭你好">梓铭</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2019
    
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>
</body>
</html>